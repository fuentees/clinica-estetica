generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// 1. CLÍNICAS
// ==========================================
model Clinic {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  slug          String   @unique
  isActive      Boolean  @default(true)
  
  logoUrl       String?  @map("logo_url")
  primaryColor  String?  @map("primary_color")
  
  cnpj          String?
  phone         String?
  email         String?
  website       String?
  
  cep           String?
  rua           String?
  numero        String?
  bairro        String?
  cidade        String?
  estado        String?
  complemento   String?
  address       String? 

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  profiles     Profile[]
  services     Service[]
  patients     Patient[]
  appointments Appointment[]
  auditLogs    AuditLog[]
  settings     SystemSetting[]
  terms        Term[]
  anamneses    Anamnesis[]

  @@map("clinics")
}

// ==========================================
// 2. PERFIS E PERMISSÕES
// ==========================================
model Profile {
  id            String    @id @db.Uuid
  email         String    
  fullName      String    @map("full_name")
  firstName     String?   @map("first_name")
  lastName      String?   @map("last_name")
  avatarUrl     String?
  phone         String?
  
  clinicId      String?   @db.Uuid
  clinic        Clinic?   @relation(fields: [clinicId], references: [id])
  
  role          String    @default("paciente") 
  roleId        String?
  assignedRole  Role?     @relation(fields: [roleId], references: [id])
  
  isActive      Boolean   @default(true)
  
  auditLogs             AuditLog[]
  appointments          Appointment[] 
  serviceProfessionals  ServiceProfessional[]
  conductedAnamneses    Anamnesis[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt

  @@map("profiles")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique 
  description String?
  profiles    Profile[]
  permissions RolePermission[]
  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  resource    String   
  action      String   
  description String?
  roles       RolePermission[]
  @@unique([resource, action])
  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// ==========================================
// 3. PACIENTES (ATUALIZADO COM LEGAL & IA)
// ==========================================
model Patient {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clinicId  String   @db.Uuid
  clinic    Clinic   @relation(fields: [clinicId], references: [id])

  name      String
  email     String?
  cpf       String?
  phone     String
  rg        String?
  date_of_birth String? 
  idade         Int?
  profissao     String?
  sexo          String?
  estado_civil  String?

  // Endereço
  cep       String?
  rua       String?
  numero    String?
  bairro    String?
  cidade    String?
  estado    String?
  address   String? 

  // ✅ NOVOS CAMPOS: JURÍDICO & CONSENTIMENTO (LGPD)
  termo_aceito    Boolean @default(false)
  autoriza_foto   Boolean @default(false)
  autoriza_midia  Boolean @default(false)
  
  // ✅ ARMAZENAMENTO DA ASSINATURA DIGITAL (BASE64) E METADADOS
  procedimentos_detalhes_json Json? @map("procedimentos_detalhes_json")

  // RELACIONAMENTOS
  consents      PatientTerm[]
  appointments  Appointment[]
  anamneses     Anamnesis[]
  aiAnalyses    AnamnesisAIAnalysis[] // Histórico de IA
  reminders     AppointmentReminder[] // Fila de Notificações
  
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@map("patients")
}

// ==========================================
// 4. MÓDULO DE IA: ANÁLISES CLÍNICAS
// ==========================================
model AnamnesisAIAnalysis {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  patientId        String   @db.Uuid @map("patient_id")
  patient          Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  anamnesis_data   Json     // Input enviado para o AnamnesisAIService
  ai_suggestions   String?  @db.Text
  risk_factors     Json?    // Lista de SafetyAlerts (DANGER, WARNING)
  suggested_treatments Json? // Protocolos sugeridos pela IA
  confidence_score Int      @default(0)
  status           String   @default("completed") // completed, flagged, rejected
  
  createdAt        DateTime @default(now()) @map("created_at")

  @@map("anamnesis_ai_analysis")
}

// ==========================================
// 5. MÓDULO DE NOTIFICAÇÕES: LEMBRETES
// ==========================================
model AppointmentReminder {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  appointment_id String    @db.Uuid
  patient_id     String    @db.Uuid
  patient        Patient   @relation(fields: [patient_id], references: [id], onDelete: Cascade)
  
  to             String    // Celular ou Email
  status         String    @default("pending") // pending, sent, failed, processing
  retry_count    Int       @default(0)
  error_message  String?
  scheduled_for  DateTime
  sent_at        DateTime?
  
  createdAt      DateTime  @default(now()) @map("created_at")

  @@map("appointment_reminders")
}

// ==========================================
// 6. ANAMNESE E AGENDAMENTOS
// ==========================================
model Anamnesis {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clinicId        String   @db.Uuid
  clinic          Clinic   @relation(fields: [clinicId], references: [id])
  patientId       String   @db.Uuid
  patient         Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  professionalId  String   @db.Uuid
  professional    Profile  @relation(fields: [professionalId], references: [id])

  mainComplaint    String   @db.Text 
  complaintDetails String?  @db.Text 

  lifestyleData    Json?    
  facialData       Json?    
  bodyData         Json?    
  capilarData      Json?    
  visualMapData    Json?    

  createdAt        DateTime @default(now())
  updatedAt        DateTime @default(now()) @updatedAt

  @@index([clinicId])
  @@index([patientId])
  @@map("anamneses")
}

model Appointment {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clinicId        String   @db.Uuid
  clinic          Clinic   @relation(fields: [clinicId], references: [id])
  startAt         DateTime
  endAt           DateTime
  status          String   
  patientId       String   @db.Uuid
  patient         Patient  @relation(fields: [patientId], references: [id])
  serviceId       String   @db.Uuid
  service         Service  @relation(fields: [serviceId], references: [id])
  professionalId  String   @db.Uuid
  professional    Profile  @relation(fields: [professionalId], references: [id])
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  @@index([clinicId, startAt, endAt])
  @@index([professionalId, startAt])
  @@map("appointments")
}

// ==========================================
// 7. FINANCEIRO E AUDITORIA
// ==========================================
model AuditLog {
  id        String   @id @default(uuid())
  clinicId  String   @db.Uuid
  clinic    Clinic   @relation(fields: [clinicId], references: [id])
  profileId String?  @db.Uuid
  profile   Profile? @relation(fields: [profileId], references: [id])
  action    String   
  entity    String   
  entityId  String?
  severity  String   @default("INFO") 
  createdAt DateTime @default(now())
  @@index([clinicId])
  @@map("audit_logs")
}

model Service {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clinicId    String   @db.Uuid
  clinic      Clinic   @relation(fields: [clinicId], references: [id])
  name        String
  price       Decimal  @db.Decimal(10, 2)
  duration    Int      
  isActive    Boolean  @default(true)
  professionals ServiceProfessional[]
  appointments  Appointment[]
  @@map("services")
}

model ServiceProfessional {
  id              String   @id @default(uuid())
  serviceId       String   @db.Uuid
  service         Service  @relation(fields: [serviceId], references: [id])
  profileId       String   @db.Uuid
  profile         Profile  @relation(fields: [profileId], references: [id])
  @@unique([serviceId, profileId])
  @@map("service_professionals")
}

model Term {
  id        String   @id @default(uuid())
  clinicId  String   @db.Uuid
  clinic    Clinic   @relation(fields: [clinicId], references: [id])
  type      String   
  title     String
  content   String   @db.Text
  version   String   
  isActive  Boolean  @default(true)
  acceptedBy PatientTerm[]
  createdAt DateTime @default(now())
  @@map("terms")
}

model PatientTerm {
  id        String   @id @default(uuid())
  patientId String   @db.Uuid
  patient   Patient  @relation(fields: [patientId], references: [id])
  termId    String
  term      Term     @relation(fields: [termId], references: [id])
  acceptedAt DateTime @default(now())
  @@map("patient_terms")
}

model SystemSetting {
  key       String
  value     String   
  clinicId  String   @db.Uuid
  clinic    Clinic   @relation(fields: [clinicId], references: [id])
  @@id([clinicId, key])
  @@map("system_settings")
}